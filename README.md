# Tesi

All the code in this repository is meant to be called in the form of `python filename.py`.
There are no arguments passed. All the configuration is done by modifying global variables at the
beginning of the python file or through `.toml` files.

## Usage

All the code is tested with Python 3.11. All the data outside the Mimic dataset (ontology and code
conversions) are found in the `data/` folder. All the code is found in the `kelso/` folder.

The output is always printed to stdout and to output files when specified in the configuration.

### Preprocessing
Configuration is done in the `PARAMETERS` section of the file. To run, call `python convert.py`.


### Models
Models are described in `kelso_model.py`. This file is meant to be imported and not executed.

The predictor model is `Kelso_Predictor`, the generator model is `Kelso_Filler`.

### Predictor
The predictor is trained through `python trainer.py`. All the configuration happen in the `.toml`
file specified in the head of `trainer.py`. An example of configuration is `config.toml`.
Results are available as text in standard output and in the log file (specified by `LOG_FILE_NAME`),
and as a csv table in the file specified by (`CSV_FILE_NAME`).

Hyperparameter selection on this model is done through `python hyper_selection.py`. Configs are
taken from the `.toml` file specified in the header of `hyper_selection.py`. An example of
configuration is found in `hyper_config.toml`

### Generator
The generator is trained through `python filler.py`. All the configuration happen in the `.toml`
file specified in the head of `filler.py`. An example of configuration is `filler_config.toml`.

### Explanations - Generator Library
The explanation pipeline relies on a library that is found in the `lib/` directory. It has to be
compiled with Zig. Instructions for the compilation of the library on linux machines follow:
1. Download the version 0.11 of the Zig compiler [link](https://ziglang.org/download/#release-0.11.0).
2. Extract the package.
3. Add the `zig` executable to the `PATH` environment variable.
4. Change the current working directory to `lib/`
5. Run `make`
At the end of the process a file `generator.so` should appear in the `lib/` directory.

At step `5.` the command `make release` can be used to compile an optimized version of the library.

Details on the structure of the library is provided in the section below.

### Explanations - Generate Explantions
To run the whole prediction+explanation pipeline on a single patient, run `python
single_explainer.py`. Configuration is found in the header section of the `single_explainer.py`
file.

### Explanations - Statistics
To compute Statistics on the explanations (including the analysis of attention) run `python
explainer.py`. Configuration on the datasets and output is found in the header of the `explainer.py`
file, together with the location of the `.toml` file, which contains parameters for the explanation.
The output is provided in a latex table format.

## Implementation of Generator Library
The files in the generator library are the following:

- `main.zig`. This is the main file that includes all the others. It provides the interface with the
  Python code. The methods visible from python are gathered in the `module_methods` global variable.

  The functions I export (except `create_c2c_table`) start with an underscore. Those functions
  convert the python arguments into `long int`, `float`, and C-style array values, and then call the
  version without initial underscore with the parsed arguments (for example `_ids_to_encoded` calls
  the `ids_to_encoded` function). The logic of the functions are contained in their versions without
  underscore. In particular, if a user wants to change a function without changing its signature,
  the functions with underscore must be left untouched. 

  If arguments involve numpy ndarray's, there is a first conversion from Python Object to Numpy
  Array, and then a conversion from Numpy Array to C-style arrays.

  In the `create_c2c_table` the portion of code responsible for parsing the arguments is signaled by
  comments.

- `tensor.zig` export a simple class to deal with multi-dimensional arrays. Examples of usage can
  be found in the tests at the end of the file.

- `numpy_data.zig` contains only the interface with the numpy library. It exports the struct
  definition of Array Object and wrapper functions around the numpy API. Refer to the Numpy C API
  if more functions are needed.

- `python.zig`. Autogenerated file containing the definitions for interfacing with python.
